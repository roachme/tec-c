â— I've completed a comprehensive analysis of the codebase and documented all findings
  in issues.txt.

  Summary

  Found 30 total issues across the codebase:
  - 3 Critical - Command injection vulnerabilities
  - 11 High - Buffer overflows and memory management issues
  - 9 Medium - Resource leaks and race conditions
  - 7 Low - Code quality issues

  Most Critical Issues

  The three command injection vulnerabilities are the most severe:

  1. lib/osdep.c:9-49 - All filesystem operations use system() with unsanitized input
  2. cli/aux/hook.c - Hook execution allows command injection through
  project/board/task names
  3. cli/aux/config.c:78-82 - Buffer overflow when parsing hook configurations

  These allow arbitrary code execution and should be fixed immediately.

  Key Recommendations

  1. Replace all system() calls with proper system APIs (mkdir, rmdir, rename, stat)
  2. Replace unsafe string functions (sprintf/strcpy/strcat) with bounds-checked
  versions
  3. Fix memory management bugs (unchecked malloc/strdup, use-after-free)
  4. Fix validation function bugs that cause undefined behavior on empty strings
  5. Replace hardcoded /tmp paths with secure temporary file creation

  All details are documented in issues.txt.







CODEBASE SECURITY AND CODE QUALITY ISSUES
==========================================
Analysis Date: 2025-11-15
Total Issues: 30 (3 Critical, 11 High, 9 Medium, 7 Low)

================================================================================
CRITICAL SEVERITY ISSUES (3)
================================================================================

1. COMMAND INJECTION VULNERABILITIES
   File: lib/osdep.c:9-49
   Severity: CRITICAL
   Description: Multiple system() calls with unsanitized user input. Functions
                MKDIR, RMDIR, MOVE, TOUCH, ISFILE, and ISDIR all use sprintf
                to build shell commands with user-controlled paths, then execute
                them via system().
   Example: Line 12: sprintf(cmd, "mkdir -p %s", path); system(cmd);
   Impact: Attackers can execute arbitrary shell commands. For example, a path
           like "; rm -rf / #" would result in command execution. This is the
           most severe vulnerability in the codebase.
   Affected: Project names, board names, task IDs, any path parameter

2. COMMAND INJECTION IN HOOK SYSTEM
   File: cli/aux/hook.c:16-17,33,121-130
   Severity: CRITICAL
   Description: Hook execution uses sprintf to build command strings with
                user-controlled data (project, board, taskid) and executes
                via system().
   Impact: Users can inject shell commands through project/board/task names
           that get executed when hooks run.

3. COMMAND INJECTION IN CONFIG HOOK PARSING
   File: cli/aux/config.c:78-82,104-108
   Severity: CRITICAL
   Description: Hook configurations are copied using strcpy without bounds
                checking into fixed-size buffers (10 bytes each in struct
                tec_hook).
   Impact: Buffer overflow can lead to code execution when parsing malicious
           config files.

================================================================================
HIGH SEVERITY ISSUES (11)
================================================================================

4. BUFFER OVERFLOW IN PATH FUNCTIONS
   File: lib/path.c:7-14
   Severity: HIGH
   Description: path_generic() uses vsprintf() without bounds checking. Static
                buffers are PATH_MAX+1 but no validation of format string
                expansion.
   Impact: Buffer overflow if combined path components exceed PATH_MAX.

5. BUFFER OVERFLOW IN DIRECTORY OPERATIONS
   File: lib/dir.c:11,18,25,32,40,49-51,59,66,73,80,89-90
   Severity: HIGH
   Description: Multiple sprintf() calls without bounds checking on PATH_MAX+1
                buffers.
   Impact: Buffer overflow if path components are too long.

6. BUFFER OVERFLOW IN LIBTEC.C
   File: lib/libtec.c:66-67
   Severity: HIGH
   Description: sprintf() used without bounds checking.
   Impact: Buffer overflow in database path construction.

7. UNSAFE STRCPY/STRCAT USAGE
   File: lib/unit.c:55,60,62
   Severity: HIGH
   Description: strcpy used without bounds checking when parsing unit files.
   Impact: Buffer overflow when reading malicious unit files.

8. BUFFER OVERFLOW IN DESCRIPTION HANDLING
   File: cli/add.c:30,33
   Severity: HIGH
   Description: Fixed 100-byte buffer for description with strcat. Task names
                up to IDSIZ can overflow.
   Impact: Stack buffer overflow.

9. DESCRIPTION BUFFER OVERFLOWS IN PROJECT/BOARD
   Files: cli/project.c:12-14, cli/board.c:22-24
   Severity: HIGH
   Description: Same pattern - 100-byte fixed buffers with strcat.
   Impact: Stack buffer overflow.

10. UNCHECKED STRDUP RETURN VALUES
    File: lib/unit.c:98-99
    Severity: HIGH
    Description: unit->key = strdup(key) and unit->val = strdup(val) are
                 checked together with ||, but if first succeeds and second
                 fails, first allocation leaks.
    Impact: Memory leak and incorrect error handling.

11. MISSING NULL CHECK AFTER MALLOC
    File: lib/list.c:21-26
    Severity: HIGH
    Description: If malloc succeeds but strdup fails, node is freed and NULL
                 returned, but this loses the original head.
    Impact: Memory leak and potential NULL pointer dereference.

12. USE-AFTER-FREE IN UNIT_SET
    File: lib/unit.c:115-118
    Severity: HIGH
    Description: free(head->val) followed by head->val = strdup(val) - if
                 strdup fails, val is freed but pointer not NULLed.
    Impact: Potential use-after-free if strdup fails and val is accessed later.

13. INTEGER UNDERFLOW IN VALIDATION FUNCTIONS
    File: lib/valid.c:15,26,36,46
    Severity: HIGH
    Description: Functions decrement pointer (*--name) at the end without
                 checking if loop body ever executed. For empty strings or
                 single-character strings, this causes undefined behavior.
    Impact: May read memory before string start, segfault or incorrect validation.

14. SIZE_T UNDERFLOW IN TRIM_WHITESPACE_END
    File: lib/unit.c:15-16
    Severity: HIGH
    Description: len = strlen(str) - 1; while (len >= 0 ...) - len is size_t
                 (unsigned), comparison with 0 is always true, infinite loop
                 for empty strings.
    Impact: Infinite loop on empty strings, program hang.

================================================================================
MEDIUM SEVERITY ISSUES (9)
================================================================================

15. MISSING ERROR CHECK ON FCLOSE
    File: cli/tec.c:242,259,275
    Severity: MEDIUM
    Description: Return value of fclose() is returned but errors during close
                 are not handled.
    Impact: Data may not be flushed to disk.

16. RACE CONDITION ON PWDFILE
    Files: cli/tec.c, tec.sh
    Severity: MEDIUM
    Description: /tmp/tecpwd is a hardcoded path accessible to all users.
    Impact: Race condition - another user could replace file between write and
            read, causing directory change to arbitrary location.

17. INSUFFICIENT INPUT VALIDATION FOR TASK ID
    File: cli/add.c:15
    Severity: MEDIUM
    Description: IDLIMIT is 9999999 but IDSIZ is 10. sprintf with IDFMT could
                 overflow.
    Impact: Buffer overflow if task ID generation reaches high values.

18. STRNCPY WITHOUT NULL TERMINATION
    File: cli/aux/toggle.c:58-59
    Severity: MEDIUM
    Description: strncpy(buf, toggle, PRJSIZ) followed by buf[PRJSIZ] = '\0'.
                 If toggle is exactly PRJSIZ bytes, this writes past buffer end.
    Impact: Off-by-one buffer overflow.

19. MISSING FCLOSE IN ERROR PATHS
    File: cli/aux/toggle.c:51-64
    Severity: MEDIUM
    Description: If fopen succeeds but tec_unit_key returns NULL, file is not
                 closed.
    Impact: File descriptor leak.

20. UNCHECKED POPEN RETURN
    File: cli/aux/hook.c:53-56
    Severity: MEDIUM
    Description: popen failure is checked but only continues; pclose is always
                 called even on NULL.
    Impact: Potential NULL pointer dereference in pclose (line 59).

21. POTENTIAL GETCHAR() INPUT ISSUE
    Files: cli/del.c:59, cli/project.c:190, cli/board.c:139
    Severity: MEDIUM
    Description: getchar() doesn't consume rest of line; multiple prompts will
                 read buffered input.
    Impact: User experience issue, not security critical.

22. MAGIC NUMBERS IN HOOK STRUCTURE
    File: cli/aux/hook.h:6-13
    Severity: MEDIUM
    Description: Fixed 10-byte buffers with FIXME comment acknowledging buffer
                 overflow risk.
    Impact: Already noted in critical issues, but design flaw.

23. HOME ENVIRONMENT VARIABLE UNCHECKED
    File: cli/aux/config.c:16,20,186
    Severity: MEDIUM
    Description: getenv("HOME") used without NULL check. Comment on line 20
                 acknowledges this.
    Impact: NULL pointer dereference if HOME is unset.

================================================================================
LOW SEVERITY ISSUES (7)
================================================================================

24. UNREACHABLE CODE
    File: lib/tree.c:26-28
    Severity: LOW
    Description: Code in comments, suggests incomplete implementation.
    Impact: Code quality issue.

25. ERROR CODE INCONSISTENCY
    File: lib/unit.c:116-118
    Severity: LOW
    Description: unit_set doesn't check if strdup succeeds after freeing old
                 value.
    Impact: Could assign NULL to head->val silently.

26. DEAD CODE/COMMENTED FUNCTIONS
    File: cli/aux/hook.c:64-101
    Severity: LOW
    Description: Large commented-out function hook_list.
    Impact: Code maintenance issue.

27. DUPLICATE MACRO DEFINITION
    File: cli/tec.h:19-20,31-32
    Severity: LOW
    Description: xstr() and str() macros defined twice.
    Impact: Compiler warning, no functional impact.

28. STATIC BUFFER REUSE
    File: lib/path.c (all functions)
    Severity: LOW
    Description: All path functions return pointer to same static buffer, not
                 thread-safe.
    Impact: Race conditions in multi-threaded use, incorrect behavior if
            multiple paths needed simultaneously.

29. ERROR MESSAGE FORMAT STRING ISSUES
    File: cli/set.c:79
    Severity: LOW
    Description: Error message says "invalid priority" but validates type.
    Impact: Confusing error messages.

30. MISSING CHECK ON CONFIG_LOOKUP
    File: cli/aux/config.c (various locations)
    Severity: LOW
    Description: Some config lookups not checked for NULL before use.
    Impact: Potential NULL pointer dereference with malformed config.

================================================================================
MOST URGENT RECOMMENDATIONS
================================================================================

1. IMMEDIATELY replace all system() calls in osdep.c with proper system APIs:
   - Use mkdir() instead of system("mkdir")
   - Use rmdir() instead of system("rmdir")
   - Use rename() instead of system("mv")
   - Use stat() family instead of system("test")

2. Replace sprintf/strcpy/strcat with snprintf/strncpy/strncat or safer
   alternatives throughout the codebase.

3. Validate and sanitize all user inputs before using in file paths or commands.

4. Fix the validation functions in lib/valid.c to handle empty strings correctly.

5. Use secure temporary file creation (mkstemp()) instead of hardcoded /tmp
   paths.

6. Add comprehensive bounds checking to all string operations.

7. Fix memory management issues:
   - Check all malloc/strdup returns
   - Fix memory leak in unit_add (lib/unit.c:98-99)
   - Fix use-after-free in unit_set (lib/unit.c:115-118)

8. Fix the size_t underflow in trim_whitespace_end to prevent infinite loops.

9. Fix integer underflow in validation functions that could cause memory access
   violations.

10. Implement proper error handling for all file operations and system calls.

================================================================================
SUMMARY
================================================================================

The codebase has serious security vulnerabilities that need immediate attention:

- 3 CRITICAL command injection vulnerabilities that allow arbitrary code execution
- 11 HIGH severity issues including buffer overflows and memory management bugs
- 9 MEDIUM severity issues affecting reliability and security
- 7 LOW severity code quality issues

The command injection vulnerabilities in osdep.c, hook.c, and config.c are
especially critical and should be addressed IMMEDIATELY before any production use.

All buffer overflow issues should be remediated by replacing unsafe C string
functions with their bounds-checked equivalents.
